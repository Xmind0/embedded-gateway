基于已经完成的优化，我来给出系统的完整线程结构图：

## 系统线程结构图

### 1. 整体线程架构
```
┌─────────────────────────────────────────────────────────────────────────────────┐
│                                Gateway System                                   │
├─────────────────────────────────────────────────────────────────────────────────┤
│  主线程 (Main Thread)                                                           │
│  ┌─────────────────────────────────────────────────────────────────────────────┐ │
│  │ main()                                                                      │ │
│  │ ├── 命令行参数解析                                                          │ │
│  │ ├── GatewayServer 初始化                                                    │ │
│  │ ├── 推理服务器配置                                                          │ │
│  │ └── 主循环 (每10秒输出统计信息)                                             │ │
│  └─────────────────────────────────────────────────────────────────────────────┘ │
└─────────────────────────────────────────────────────────────────────────────────┘
                                    │
                                    ▼
┌─────────────────────────────────────────────────────────────────────────────────┐
│                            GatewayServer 线程组                                 │
├─────────────────────────────────────────────────────────────────────────────────┤
│  ┌─────────────────┐  ┌─────────────────┐  ┌─────────────────┐  ┌──────────────┐ │
│  │ 消息处理线程     │  │ 客户端事件线程   │  │ 推理连接线程     │  │ 任务管理线程组 │ │
│  │ message_thread  │  │ event_thread    │  │ event_thread    │  │              │ │
│  │                 │  │ (ClientManager) │  │ (InferenceMgr)  │  │              │ │
│  └─────────────────┘  └─────────────────┘  └─────────────────┘  └──────────────┘ │
└─────────────────────────────────────────────────────────────────────────────────┘
                                                                    │
                                                                    ▼
┌─────────────────────────────────────────────────────────────────────────────────┐
│                              任务管理线程组                                      │
├─────────────────────────────────────────────────────────────────────────────────┤
│  ┌─────────────────┐  ┌─────────────────┐  ┌─────────────────┐                  │
│  │ 任务处理线程     │  │ 任务分配线程     │  │ 响应清理线程     │                  │
│  │ task_thread     │  │ assignment_thread│  │ cleanup_thread  │                  │
│  │                 │  │                 │  │ (ResponseMgr)   │                  │
│  └─────────────────┘  └─────────────────┘  └─────────────────┘                  │
└─────────────────────────────────────────────────────────────────────────────────┘
```

### 2. 详细线程结构图

```
系统总线程数: 7个固定线程
┌─────────────────────────────────────────────────────────────────────────────────┐
│                                线程详细结构                                     │
├─────────────────────────────────────────────────────────────────────────────────┤
│                                                                                 │
│  1. 主线程 (Main Thread)                                                       │
│  ┌─────────────────────────────────────────────────────────────────────────────┐ │
│  │ main()                                                                      │ │
│  │ ├── printUsage()                    # 显示使用说明                          │ │
│  │ ├── parseStrategy()                 # 解析任务分配策略                      │ │
│  │ ├── parseInferenceServer()          # 解析推理服务器地址                    │ │
│  │ ├── GatewayServer::GatewayServer()  # 构造网关服务器                        │ │
│  │ ├── GatewayServer::setTaskAssignmentStrategy()  # 设置任务分配策略          │ │
│  │ ├── GatewayServer::addInferenceServer()         # 添加推理服务器            │ │
│  │ ├── GatewayServer::start()          # 启动网关服务器                        │ │
│  │ └── 主循环 (每10秒输出统计信息)                                             │ │
│  │    ├── TaskManager::getPendingTaskCount()                                 │ │
│  │    ├── TaskManager::getCompletedTaskCount()                               │ │
│  │    └── TaskManager::getFailedTaskCount()                                  │ │
│  └─────────────────────────────────────────────────────────────────────────────┘ │
│                                                                                 │
│  2. 消息处理线程 (Message Processing Thread)                                   │
│  ┌─────────────────────────────────────────────────────────────────────────────┐ │
│  │ GatewayServer::messageProcessingLoop()                                     │ │
│  │ ├── ClientMessageCache::getNextMessage()  # 获取下一个消息                 │ │
│  │ └── processMessage()                # 处理消息                             │ │
│  │    └── TaskManager::processRequest()     # 转发给任务管理器                 │ │
│  └─────────────────────────────────────────────────────────────────────────────┘ │
│                                                                                 │
│  3. 客户端事件线程 (Client Event Thread)                                       │
│  ┌─────────────────────────────────────────────────────────────────────────────┐ │
│  │ ClientManager::eventLoop()          # 单线程事件循环                        │ │
│  │ ├── select()                        # 多路复用等待事件                      │ │
│  │ │   ├── 服务器socket (新连接)                                              │ │
│  │ │   └── 客户端socket[] (数据可读)                                          │ │
│  │ ├── acceptNewClient()               # 处理新客户端连接                      │ │
│  │ │   ├── accept()                    # 接受连接                             │ │
│  │ │   ├── 设置非阻塞模式                                                      │ │
│  │ │   ├── 添加到客户端映射                                                    │ │
│  │ │   └── FD_SET()                    # 添加到select集合                     │ │
│  │ └── handleClientData()              # 处理客户端数据                        │ │
│  │    ├── recv()                      # 非阻塞读取数据                         │ │
│  │    ├── 创建RequestMessage                                                  │ │
│  │    └── 添加到消息缓存                                                       │ │
│  └─────────────────────────────────────────────────────────────────────────────┘ │
│                                                                                 │
│  4. 推理连接线程 (Inference Connection Thread)                                 │
│  ┌─────────────────────────────────────────────────────────────────────────────┐ │
│  │ InferenceConnectionManager::eventLoop()  # 单线程事件循环                   │ │
│  │ ├── select()                            # 多路复用等待事件                  │ │
│  │ │   └── 推理服务器socket[] (数据可读)                                      │ │
│  │ ├── handleInferenceData()               # 处理推理服务器数据                │ │
│  │ │   ├── 查找对应的InferenceConnector                                      │ │
│  │ │   ├── connector->handleDataReceive()  # 处理数据接收                     │ │
│  │ │   └── 回调处理响应                                                       │ │
│  │ └── cleanupDisconnectedConnections()    # 清理断开的连接                    │ │
│  │    ├── 检查连接状态                                                         │ │
│  │    ├── 移除断开的连接                                                       │ │
│  │    └── 更新select集合                                                     │ │
│  └─────────────────────────────────────────────────────────────────────────────┘ │
│                                                                                 │
│  5. 任务处理线程 (Task Processing Thread)                                      │
│  ┌─────────────────────────────────────────────────────────────────────────────┐ │
│  │ TaskManager::taskProcessingLoop()                                          │ │
│  │ ├── SimpleQueue::pop()        # 从队列获取任务                             │ │
│  │ ├── processTask()             # 处理单个任务                               │ │
│  │ └── assignTaskToInferenceServer()  # 分配任务到推理服务器                   │ │
│  │    └── InferenceConnectionManager::sendInferenceRequest()                  │ │
│  └─────────────────────────────────────────────────────────────────────────────┘ │
│                                                                                 │
│  6. 任务分配线程 (Task Assignment Thread)                                      │
│  ┌─────────────────────────────────────────────────────────────────────────────┐ │
│  │ TaskManager::taskAssignmentLoop()                                          │ │
│  │ ├── checkTaskTimeout()        # 检查任务超时                               │ │
│  │ └── cleanupTimeoutTasks()     # 清理超时任务                               │ │
│  └─────────────────────────────────────────────────────────────────────────────┘ │
│                                                                                 │
│  7. 响应清理线程 (Response Cleanup Thread)                                     │
│  ┌─────────────────────────────────────────────────────────────────────────────┐ │
│  │ ResponseManager::cleanupLoop()                                             │ │
│  │ ├── cleanupExpiredResponses() # 清理过期响应                               │ │
│  │ └── 超时处理                                                                │ │
│  │    └── ResponseManagerCallback::onResponseTimeout()                        │ │
│  └─────────────────────────────────────────────────────────────────────────────┘ │
└─────────────────────────────────────────────────────────────────────────────────┘
```

### 3. 线程间通信关系图

```
线程间数据流:
┌─────────────────────────────────────────────────────────────────────────────────┐
│                                数据流向图                                       │
├─────────────────────────────────────────────────────────────────────────────────┤
│                                                                                 │
│  主线程                                                                         │
│  ┌─────────────┐                                                               │
│  │ main()      │                                                               │
│  └─────┬───────┘                                                               │
│        │                                                                       │
│        ▼                                                                       │
│  ┌─────────────┐                                                               │
│  │GatewayServer│                                                               │
│  └─────┬───────┘                                                               │
│        │                                                                       │
│        ├─────────────────┬─────────────────┬─────────────────┐                 │
│        │                 │                 │                 │                 │
│        ▼                 ▼                 ▼                 ▼                 │
│  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐           │
│  │ClientManager│  │InferenceMgr │  │TaskManager  │  │MessageProc  │           │
│  │(事件线程)    │  │(事件线程)   │  │(任务线程组)  │  │(消息线程)    │           │
│  └─────┬───────┘  └─────┬───────┘  └─────┬───────┘  └─────┬───────┘           │
│        │                 │                 │                 │                 │
│        │                 │                 │                 │                 │
│        ▼                 ▼                 ▼                 │                 │
│  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐          │                 │
│  │客户端连接池  │  │推理连接池    │  │任务队列      │          │                 │
│  │(select管理)  │  │(select管理)  │  │(线程安全)    │          │                 │
│  └─────┬───────┘  └─────┬───────┘  └─────┬───────┘          │                 │
│        │                 │                 │                 │                 │
│        │                 │                 │                 │                 │
│        └─────────────────┼─────────────────┼─────────────────┘                 │
│                          │                 │                                   │
│                          ▼                 ▼                                   │
│                    ┌─────────────┐  ┌─────────────┐                           │
│                    │响应管理器    │  │消息缓存队列  │                           │
│                    │(清理线程)    │  │(线程安全)    │                           │
│                    └─────────────┘  └─────────────┘                           │
└─────────────────────────────────────────────────────────────────────────────────┘
```

### 4. 线程同步机制图

```
互斥锁和同步机制:
┌─────────────────────────────────────────────────────────────────────────────────┐
│                                同步机制图                                       │
├─────────────────────────────────────────────────────────────────────────────────┤
│                                                                                 │
│  互斥锁 (Mutex):                                                                │
│  ├── clients_mutex              # 客户端映射保护                               │
│  ├── connectors_mutex           # 推理连接器列表保护                            │
│  ├── pending_tasks_mutex        # 待处理任务映射保护                            │
│  ├── response_map_mutex         # 响应映射保护                                 │
│  └── servers_mutex              # 推理服务器配置保护                            │
│                                                                                 │
│  原子变量 (Atomic):                                                             │
│  ├── running                    # 线程运行状态                                 │
│  ├── pending_task_count         # 待处理任务计数                               │
│  ├── completed_task_count       # 完成任务计数                                 │
│  ├── failed_task_count          # 失败任务计数                                 │
│  └── round_robin_index          # 轮询索引                                     │
│                                                                                 │
│  线程安全队列:                                                                   │
│  ├── SimpleQueue<InferenceRequest*>  # 任务队列                                │
│  ├── SimpleQueue<InferenceResponse*> # 响应队列                                │
│  └── ClientMessageCache              # 客户端消息缓存                           │
│                                                                                 │
│  回调机制:                                                                      │
│  ├── InferenceConnectorCallback     # 推理连接器回调                           │
│  ├── ResponseManagerCallback        # 响应管理器回调                           │
│  └── 异步事件通知                                                               │
└─────────────────────────────────────────────────────────────────────────────────┘
```

### 5. 线程生命周期图

```
线程启动和关闭顺序:
┌─────────────────────────────────────────────────────────────────────────────────┐
│                                生命周期图                                       │
├─────────────────────────────────────────────────────────────────────────────────┤
│                                                                                 │
│  启动顺序:                                                                      │
│  1. 主线程启动                                                                  │
│  2. GatewayServer::start()                                                     │
│  3. ClientManager::start() → event_thread                                      │
│  4. TaskManager::start()                                                       │
│  5. InferenceConnectionManager::start() → event_thread                         │
│  6. ResponseManager::startCleanupThread() → cleanup_thread                     │
│  7. TaskManager::start() → task_thread + assignment_thread                     │
│  8. GatewayServer::start() → message_thread                                    │
│                                                                                 │
│  关闭顺序:                                                                      │
│  1. 主线程收到停止信号                                                          │
│  2. GatewayServer::stop()                                                      │
│  3. 停止所有工作线程                                                            │
│  4. 等待所有线程join()                                                         │
│  5. 清理资源                                                                   │
│  6. 主线程退出                                                                  │
│                                                                                 │
│  线程状态转换:                                                                  │
│  ┌─────────────┐    ┌─────────────┐    ┌─────────────┐                        │
│  │  未启动      │───▶│  运行中      │───▶│  已停止      │                        │
│  └─────────────┘    └─────────────┘    └─────────────┘                        │
└─────────────────────────────────────────────────────────────────────────────────┘
```

### 6. 性能优化对比

```
优化效果总结:
┌─────────────────────────────────────────────────────────────────────────────────┐
│                                性能对比                                         │
├─────────────────────────────────────────────────────────────────────────────────┤
│                                                                                 │
│  线程数量:                                                                      │
│  ├── 优化前: 6-1005个线程 (取决于客户端和推理服务器数量)                        │
│  ├── 优化后: 7个固定线程                                                        │
│  └── 减少比例: 99.3% (从最多1005个减少到7个)                                   │
│                                                                                 │
│  内存使用:                                                                      │
│  ├── 优化前: 大量线程栈内存 (每个线程约8MB)                                     │
│  ├── 优化后: 固定线程栈内存 (7个线程约56MB)                                     │
│  └── 内存节省: 显著减少                                                         │
│                                                                                 │
│  系统资源:                                                                      │
│  ├── 上下文切换: 大幅减少                                                       │
│  ├── 调度开销: 显著降低                                                         │
│  ├── 扩展性: 支持更多连接而不增加线程数                                        │
│  └── 稳定性: 减少线程竞争和死锁风险                                            │
│                                                                                 │
│  响应性能:                                                                      │
│  ├── select多路复用: 更好的事件响应能力                                        │
│  ├── 非阻塞I/O: 提高并发处理效率                                               │
│  └── 事件驱动: 减少轮询开销                                                    │
└─────────────────────────────────────────────────────────────────────────────────┘
```

这个优化后的系统采用了**事件驱动架构**和**单线程多路复用模式**，通过7个固定线程实现了高并发的网关服务，具有优秀的性能和扩展性。